$schema: "https://stage0/schemas/process.schema.yaml"
$id: "https://stage0/template-configurator-api/process.yaml"
title: Process file for a MongoDB configurator API template
version: "1.0"

environment:
  SERVICE_NAME: Service name from architecture.yaml

context:
  - key: info
    type: path
    path: specifications.product.info
  - key: org
    type: path
    path: specifications.product.organization
  - key: dictionaries
    type: path
    path: specifications.catalog.data_dictionaries
  - key: architecture
    type: path
    path: specifications.architecture.architecture
  - key: service
    type: selector
    path: architecture.domains
    filter:
      property: name
      value: "{{ SERVICE_NAME }}"
  - key: repo
    type: selector
    path: service.repos
    filter:
      property: type
      value: "spa"

requires:
  - info.name
  - info.slug
  - org.name
  - org.email
  - dictionaries   
  - architecture.domains
  - service.name
  - service.data_domains.controls
  - service.data_domains.creates
  - service.data_domains.consumes
  - repo.name
  - repo.port
  - repo.type

templates:
  - path: "./.github/workflows/docker-push.yml"
    merge: true
  - path: "./LICENSE"
    merge: true
  - path: "./README.md.template"
    output: "./README.md"
    merge: true
  - path: "./index.html"
    merge: true
  - path: "./Makefile"
    output: "/dev/null"
    merge: true
  - path: "./Dockerfile"
    merge: true
  - path: "./.npmrc"
    merge: true
  - path: "./package.json"
    merge: true
  - path: "./vite.config.ts"
    merge: true
  - path: "./cypress.config.ts" 
    merge: true
  - path: "./cypress/e2e/control.cy.template.ts"
    mergeFor:
      items: service.data_domains.controls
      output: "./cypress/e2e/{{item | lower}}.cy.ts"
  - path: "./cypress/e2e/create.cy.template.ts"
    mergeFor:
      items: service.data_domains.creates
      output: "./cypress/e2e/{{item | lower}}.cy.ts"
  - path: "./cypress/e2e/consume.cy.template.ts"
    mergeFor:
      items: service.data_domains.consumes
      output: "./cypress/e2e/{{item | lower}}.cy.ts"
  - path: "./cypress/e2e/navigation.cy.ts"
    merge: true
  - path: "./src/composables/useRoles.ts"
    merge: true
  - path: "./src/pages/LoginPage.template.vue"
    output: "./src/pages/LoginPage.vue"
    merge: true
  - path: "./src/pages/AdminPage.template.vue"
    output: "./src/pages/AdminPage.vue"
    merge: true
  - path: "./src/router/index.ts"
    merge: true
  - path: "./src/App.vue"
    merge: true

  # API types and client (generated from data domains)
  - path: "./src/api/types.template.ts"
    output: "./src/api/types.ts"
    merge: true
  - path: "./src/api/client.template.ts"
    output: "./src/api/client.ts"
    merge: true
  - path: "./src/api/client.test.template.ts"
    output: "./src/api/client.test.ts"
    merge: true
  - path: "./src/api/client.test.control.template.ts"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/api/{{item}}.client.test.ts"
  - path: "./src/api/client.test.create.template.ts"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/api/{{item}}.client.test.ts"
  - path: "./src/api/client.test.consume.template.ts"
    mergeFor:
      items: service.data_domains.consumes
      output: "./src/api/{{item}}.client.test.ts"

  # Control domain pages (one per service.data_domains.controls)
  - path: "./src/pages/ControlsListPage.template.vue"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/pages/{{item}}sListPage.vue"
  - path: "./src/pages/ControlNewPage.template.vue"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/pages/{{item}}NewPage.vue"
  - path: "./src/pages/ControlEditPage.template.vue"
    mergeFor:
      items: service.data_domains.controls
      output: "./src/pages/{{item}}EditPage.vue"

  # Create domain pages (one per service.data_domains.creates)
  - path: "./src/pages/CreatesListPage.template.vue"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/pages/{{item}}sListPage.vue"
  - path: "./src/pages/CreateNewPage.template.vue"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/pages/{{item}}NewPage.vue"
  - path: "./src/pages/CreateViewPage.template.vue"
    mergeFor:
      items: service.data_domains.creates
      output: "./src/pages/{{item}}ViewPage.vue"

  # Consume domain pages (one per service.data_domains.consumes)
  - path: "./src/pages/ConsumesListPage.template.vue"
    mergeFor:
      items: service.data_domains.consumes
      output: "./src/pages/{{item}}sListPage.vue"
  - path: "./src/pages/ConsumeViewPage.template.vue"
    mergeFor:
      items: service.data_domains.consumes
      output: "./src/pages/{{item}}ViewPage.vue"

  # # Config Test Data files for each Collection Name
  # - path: "./tests/test_data/config/STRING.template"
  #   mergeFor:
  #     items: dictionaries
  #     output: "./tests/test_data/config/{{name | upper}}_COLLECTION_NAME"

  # # Config Test Data for Port Numbers
  # - path: "./tests/test_data/config/API_PORT.template"
  #   mergeFor: 
  #     items: architecture.domains
  #     output: "./tests/test_data/config/{{name | upper}}_API_PORT"
      
  # - path: "./tests/test_data/config/SPA_PORT.template"
  #   mergeFor:
  #     items: architecture.domains
  #     output: "./tests/test_data/config/{{name | upper}}_SPA_PORT"